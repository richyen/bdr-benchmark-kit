#!/bin/bash -eux

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
{% if architecture in ['gold', 'silver'] %}
TPAEXEC_BIN_DIR={{ configuration['tpa_bin_path'] }}

export EDB_REPO_CREDENTIALS_FILE=${SCRIPT_DIR}/edb-repo-creds.txt
export TPA_2Q_SUBSCRIPTION_TOKEN="{{ configuration['tpa_subscription_token'] }}"
{% endif %}

export ANSIBLE_PIPELINING='true'
export ANSIBLE_SSH_PIPELINING='true'

{% if architecture in ['gold', 'silver'] %}
# TPexec provision & deploy
${TPAEXEC_BIN_DIR}/tpaexec relink .
${TPAEXEC_BIN_DIR}/tpaexec provision .
{% endif %}
./add_hosts.sh

## XXX Ugly hack because I can't get tpaexec to use tpa_known_hosts
for h in `cat add_hosts.sh | grep scan | awk '{ print $3 }'`; do
  ssh -i ssh-id_rsa -o "strictHostKeyChecking=no" rocky@${h} "echo $h" > /dev/null
done

{% if architecture in ['gold', 'silver'] %}
# Deploy using TPAexec
${TPAEXEC_BIN_DIR}/tpaexec deploy .
{% endif %}
